# postweb前后端交互部分

## 1.前端框架

前端部分是基于D2admin框架搭建而成

D2admin的相关资料介绍见官网

``` text
https://d2.pub/zh/doc/d2-admin/
```

## 2.api接口分类

### 2.1 数据处理模块

- GET_DEALS  ：  获取预测顺序
- GET_RAW_DEAL_TREE  ： 获取原始数据目录
- GET_RAW_DEAL  :  获取原始数据
- GEN_PREDICT_DEAL  :   生成数据任务
- GET_GEN_TASK   ：  获取生成任务的情况

### 2.2 模型管理模块

- GET_REGISTER_MODELS  ：  暂未使用 
- GET_MODEL_DETAIL  ：  获取模型状态
- UNREGISTER_MODEL  ：  卸载模型
- UPDATE_MODEL   ：  更新模型
- PREDICT_MODEL  ： 预测模型

 

## 3.前端api 接口调用流程

### 3.1 数据管理模块

#### 3.1.1 GET_RAW_DEAL_TREE（获取原始数据目录）

- 使用位置：原始数据页面中选择原始数据的下拉选项卡
- 调用函数：getRawDataTree(){}
  - 函数作用：异步获取原始数据的目录，使用dfs深度优先算法将目录树中的内容输出至与页面绑定的options选项中。
  - 位置：
    - 绑定于vue生命周期mounted ()中
    - 作用：  提前声明变量，进入页面内容全部渲染完成后自动引函数 
- 调用流程：
  - 前端：
    - 绑定elementUI中的Cascader 级联选择器中的options
    - getRawDataTree()中调用接口
    - 进入api接口内部后，以路由及请求方式为请求传入后端api
  - API端：
    - api接口以对应方式调用其请求函数
    - 以当前环境为基础，调用rpc客户端，获取到rpc请求接口
    - 将请求接口及当前环境传至rpc服务端的处理接口
  - RPC端：
    - rpc服务端处理相关请求
      - 从mangdb中获取所有不重复的tag的值（数据形式为 “杭州市-20210401" ）
      - 将tag值进行处理，得到地区及日期
      - 将处理后的数据存放在预先设定好的Tree结构中
    - 将处理好的Tree结构数据作为响应返回给rpc服务端
  - API端：
    - 将响应返回数据中的Tree结构传给 api 返回数据。
  - 前端：
    - 前端获取到api的返回数据，即Tree的数据。

#### 3.1.2 GET_RAW_DEAL （ 获取原始数据）

- 使用位置：原始数据页面中选择原始数据的下拉选项卡中的最终选项，点击即触发调用
- 调用函数：getRawData(tag, source, pageSize, pageNum){}
  - 函数作用：以选中的选项中的地区和时间作为tag及source的值，以及pageSize, pageNum作为参数，获取到原始数据，将数据展示与对应表格中
  - 位置：
    - 绑定于vue生命周期watch中的 handler 属性
    - 作用： 用来响应数据的变化。handler属性用于对象内有多个属性，每个属性都会被侦听，每个属性的变化都会执行一次侦听操作。 
    -  vue官方文档解释当需要在数据变化时执行异步或开销较大的操作时，推荐使用该方法。 
- 调用流程：
  - 前端：
    - watch中的 handler 属性一直监听该函数参数的变化，一旦下拉选项卡中的最终选项被选择后异步执行函数接口
    - 进入api接口内部后，以路由及请求方式和请求数据（tag、source、pageSize、pageNum）为请求传入后端api
  - API端：
    - api接口以对应方式调用其请求函数
    - 创建一个结构体，作为接收请求数据的结构
    - 在当前环境下，将这个结构体的所有字段作为rpc客户端的请求
    - 将请求接口及当前环境传至rpc服务端的处理接口
  - RPC端：
    - rpc服务端处理相关请求
      - 将tag、pageSize、pageNum作为参数，从mangodb中获取数据
        - mangodb中以tag为目标获取到所有相关数据
      - 将从mangodb中获取到的数据的格式转化为前端表格所对应的格式
    - 将处理好的数据作为响应返回给rpc服务端
  - API端：
    - 接收到响应成功的返回信息
  - 前端：
    - 前端获取到api的返回数据，即为表格数据



#### 3.1.3 GEN_PREDICT_DEAL（生成数据任务）

- 使用位置：原始数据页面中的生成预测数据按钮
- 调用函数：genTask(tag){}
  - 函数作用：以tag作为参数，生成预测数据的任务
  - 位置：
    - vue生命周期的methods中
    - 作用：存放方法体
- 调用流程：
  - 前端：
    - 点击生成预测数据按钮后，调用函数
    - 进入api接口内部后，以路由及请求方式为请求传入后端api
  - API端：
    - api接口以对应方式调用其请求函数
    - 获取到路由所带的tag参数
    - 在当前环境下，将tag作为rpc客户端的请求
    - 将请求接口及当前环境传至rpc服务端的处理接口
  - RPC端：
    - rpc服务端处理相关请求
      - 生成特有的UUID，将UUID和tag作为任务发送到mq的生产者
        - mq生产者将当前的topic及UUID和tag组成的taskjson数据作为消息发送给消费端
        - mq消费端接受到id及tag后，将数据进行处理，并同时更新处理的进度，将处理进度存放于MySQL数据库中。
        - 第一步：提交任务，将数据存放与UUID.csv文件中
        - 第二步：数据的预处理，
        - 第三步： 生成预测数据 
        - 第四步： 持久化到Mongo 
        - 第五步：任务完成
      - 将UUID存放与返回的响应中
      - 从MySQL数据库中获取到任务进度
  - API端：
    - 将响应返回数据中的UUID传给 api 的返回数据。
    - 响应成功

#### 3.1.4 GET_GEN_TASK（获取生成任务的情况）

- 使用位置：数据处理进度位置的进度条
- 调用函数：loadTaskStatus(tag){}
  - 函数作用：以tag为参数，首先从数据库中获取到预测任务的taskId，将taskId作为路由参数，获取到数据处理的状态，实时将任务状态更新至数据处理进度的进度条中
  - 位置：vue生命周期的methods中
- 调用流程：
  - 前端：
    - 前端监听到数据的变化之后，随即运行该函数
    - 进入api接口内部后，以路由及请求方式为请求传入后端api
  - API端：
    - api接口以对应方式调用其请求函数
    - 获取到路由所带的taskId参数
    - 在当前环境下，将taskId作为rpc客户端的请求
    - 将请求接口及当前环境传至rpc服务端的处理接口
  - RPC端：
    - rpc服务端处理相关请求
      - 以taskId作为参数从MySQL数据库中获取到当前task
      - 将当前任务的状态作为响应返回给rpc客户端
  - API端：
    - 接收到返回的任务状态
    - 响应成功
  - 前端：
    - 更新进度条



### 3.2 模型管理模块

#### 3.2.1 GET_MODEL_DETAIL（获取模型状态）

- 使用位置：
  - 模型列表页面自动加载模型
    - 调用函数：getModelsData() {}
      - 函数作用：获取模型列表
      - 位置：
        - 写在声明周期methods，绑定于生命周期created中
        - created 作用： 在模板渲染成`html`前调用，即通常初始化某些属性值，然后再渲染成视图。 
        - 与mounted的区别：在模板渲染成`html`后调用，通常是初始化页面完成后，再对`html`的`dom`节点进行一些操作。
  - 预测页面的预测模型下拉条
    - 调用函数：getModelList() {}
      - 函数作用：获取模型列表，将模型展示在下拉列表中
      - 位置：
        - 写在声明周期methods，绑定于生命周期mounted中
- 调用流程：

1. 模型列表

   - 前端：
     - 在模板渲染成`html`前调用该函数
     - 进入api接口内部后，以路由及请求方式为请求传入后端api
   - API端：
     - api接口以对应方式调用其请求函数
     - 以当前环境为基础，调用rpc客户端，获取到rpc请求接口
     - 将请求接口及当前环境传至rpc服务端的处理接口
   - RPC端：
     - rpc服务端处理相关请求
       - 从torchserve中获取到模型状态
         - 从torchserve中获取模型列表
           - torchserve的RPC客户端处理请求，获取到模型管理RPC客户端返回的响应
           - 将返回的响应转化为json格式，存放于模型列表的结构中，其中内容为模型列表
         - 获取到模型列表中的模型名称，将其作为参数，从torchserve的HTTP服务中获取到该模型的状态
         - 将模型状态从torchserve的模式转变为RPC的模式
           - 从torchserve模式中获取到模型的所有参数
           - 将所有属性参数存放入模型状态结构体中
       - 将模型状态作为响应返回给rpc客户端
   - API端：
     - 接收到返回的模型状态
     - 响应成功
   - 前端：
     - 默认在模型列表中展示所有模型，及其所有属性

   

2. 预测页面

   - 前端：
     - mounted中的函数默认在模板渲染成`html`后调用
     - 进入api接口内部后，以路由及请求方式为请求传入后端api
   - API端：
     - 同上
   - RPC端：
     - 同上
   - API端：
     - 同上
   - 前端：
     - 将模型状态中的模型名称、版本读取出来，并将其展示于预测页面的预测模型下拉选项卡中



#### 3.2.2 UNREGISTER_MODEL （卸载模型）

- 使用位置：模型列表中的卸载该版本按钮
- 调用函数：removeModel(idx){}
  - 函数作用：将选中的模型的名称及版本作为参数，从模型列表中将该模型删除
  - 位置：存放于生命周期methods中，绑定在卸载该版本按钮上。
- 调用流程：
  - 前端：
    - 点击卸载该版本按钮，触发该函数
    - 进入api接口内部后，以路由及请求方式为请求传入后端api
  - API端：
    - api接口以对应方式调用其请求函数
    - 获取到路由所带的模型名称及模型版本参数
    - 在当前环境下，将模型名称及模型版本作为rpc客户端的请求
    - 将请求接口及当前环境传至rpc服务端的处理接口
  - RPC端：
    - rpc服务端处理相关请求
      - 将模型名称及模型版本作为模型管理rpc客户端的请求
      - 模型管理服务端按照模型名称及模型版本为参数，删除相应模型
    - 如果删除失败会返回错误信息，删除成功则返回成功信息
  - API端：
    - 接收到返回的成功信息
  - 前端：
    - 展示出删除成功的提示框



#### 3.2.3 UPDATE_MODEL（更新模型）

- 使用位置：模型列表中调整参数配置按钮
- 调用函数：updateModel() {}
  - 函数作用：修改模型最大实例数和最小实例数
  - 位置：存放于生命周期methods中，绑定在调整参数配置按钮上。
- 调用流程：
  - 前端：
    - 点击调整参数配置按钮，触发该函数
    - 进入api接口内部后，以路由及请求方式和请求数据最大实例数和最小实例数为请求传入后端api
  - API端：
    - api接口以对应方式调用其请求函数
    - 获取到路由所带的模型名称及模型版本参数，以及请求中的数据最大实例数和最小实例数
    - 创建一个结构体，作为接收请求数据最大实例数和最小实例数的结构
    - 在当前环境下，将模型名称及模型版本及最大实例数和最小实例数作为rpc客户端的请求
    - 将请求接口及当前环境传至rpc服务端的处理接口
  - RPC端：
    - rpc服务端处理相关请求
      - 获取到模型的id及配置信息
      - 将模型名称及模型版本作为模型管理rpc客户端的请求
      - 模型管理服务端将修改后的最大实例数和最小实例数同步至模型状态中
    - 返回成功信息
  - API端：
    - 接收到返回的成功信息
  - 前端：
    - 展示出修改成功的提示框

#### 3.2.4 REGISTER_MODEL（注册模型）前端请求部分暂时没写

- 使用位置：模型列表页面中导入按钮
- 调用函数：loadModel() {}
  - 函数作用：从URL地址或者本地地址中注册模型
  - 位置：生命周期methods中，绑定与导入按钮
- 调用流程：
  - 前端：
    - 点击导入按钮，触发该函数
    - 进入api接口内部后，以路由及请求方式和注册地址为请求传入后端api
  - API端：
    - api接口以对应方式调用其请求函数
    - 创建一个结构体，作为接收请求数据（注册地址）的结构
    - 在当前环境下，将这个结构体的所有字段作为rpc客户端的请求
    - 将请求接口及当前环境传至rpc服务端的处理接口
  - RPC端：
    - rpc服务端处理相关请求
      - 检查请求数据（注册地址）是否符合参数规范
      - 获取到注册地址中模型名称
      - 将模型名称及相关参数（初始实例数、是否同步加载、模型URL）作为模型管理客户端的请求
    - 将注册是否成功的信息返回给RPC客户端
  - API端：
    - 接收到注册成功的信息
  - 前端：
    - 展示出注册成功的提示框



### 3.3 模型预测模块

#### 3.3.1 PREDICT_MODEL（预测模型）

- 使用位置：通过预测页面的绘制按钮调用一系列函数后调用该接口
- 调用函数：getPredictOrder(curIdx) {}
  - 函数作用：画出预测顺序的路径
  - 位置：changeDealIdx函数调用setOrderText函数 ，setOrderText函数调用setPredictText函数，setPredictText函数最终调用getPredictOrder函数，调用了API接口。该函数在生命周期methods中，绑定在生命周期mounted和watch中。
- 调用流程：
  - 前端：
    - 点击绘制按钮，触发一系列函数，最终调用API接口
    - 进入api接口内部后，以路由及请求方式和请求数据为请求传入后端api
  - API端：
    - api接口以对应方式调用其请求函数
    - 获取到路由所带的模型名称及模型版本参数
    - 获取到预测输入数据
    - 将预测输入数据由API转换成RPC的输入
    - 在当前环境下，将模型名称及模型版本及RPC的输入数据作为rpc客户端的请求
    - 将请求接口及当前环境传至rpc服务端的处理接口
  - RPC端：
    - rpc服务端处理相关请求
      - 将请求数据由RPC转换成Torch
      - 调用Torchserve的预测
        - 将模型名称及模型版本及Torch的输入数据作为模型预测rpc客户端的请求
        - 返回预测的输出数据
      - 将预测的输出数据中的顺序返回响应给rpc服务端
  - API端：
    - 接收到预测的顺序数据，将其返回给前端数据
  - 前端：
    - 在预测页面的预测结果处依次显示出预测的顺序

#### 3.3.2 GET_DEALS（获取预测顺序）

- 使用位置：预测页面中揽件路径的预测结果顺序，与上一个接口在页面加载及绘制按钮点击时同时被调用
- 调用函数：getData(){}
  - 函数作用：获取到预测的顺序
  - 位置：存放于生命周期methods中，绑定于生命周期mounted和watch中，会在页面数据发生变化是被调用。
- 调用流程：
  - 前端：
    - 加载页面时默认触发该函数调用api接口
    - 进入api接口内部后，以路由及请求方式和请求数据（region、dealDate、pageNum、PageSize）为请求传入后端api
  - API端：
    - api接口以对应方式调用其请求函数
    - 创建一个结构体，作为接收请求数据（region、dealDate、pageNum、PageSize）的结构
    - 在当前环境下，将这个结构体的所有字段作为rpc客户端的请求
    - 将请求接口及当前环境传至rpc服务端的处理接口
  - RPC端：
    - rpc服务端处理相关请求
      - 从mangodb中获取到预测数据
        - 以region、dealDate、pageNum、PageSize这些数据作为参数，查询mangodb数据库
        - 以date和region为参数查询相关的预测数据
      - 将mangodb中查询到的数据转化为rpc格式
    - 将rpc格式的数据传给rpc客户端
  - API端：
    - 接收到预测数据
    - 将数据返回给前端
  - 前端：
    - 处理预测数据
    - 将预测数据中的顺序展示在预测结果处